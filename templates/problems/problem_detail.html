<!-- templates/problems/problem_detail.html -->
{% extends 'base.html' %}
{# REMOVE THIS LINE: {% load custom_filters %} #}

{% block title %}{{ problem.name }} - Online Judge{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card p-4 mb-4">
                <h2 class="card-title">{{ problem.name }}</h2>
                <span class="badge bg-{{ problem.difficulty|lower }} mb-3">{{ problem.difficulty|capfirst }}</span>
                <hr>
                <div class="card-text">
                    {{ problem.statement|safe }} {# Use 'safe' filter if problem statement might contain HTML #}
                </div>
                <hr>
                <h4 class="mt-4">Sample Input:</h4>
<pre class="bg-light p-3 rounded border"><code>{% for tc in problem.test_cases.all %}
    {% if not tc.is_hidden %}
        {{ tc.input_data }}
        {# We only want the first, so the loop effectively breaks by not adding more after the first #}
        {# This is not a 'break' tag, but implicit due to how we structure or might use .first in view #}
    {% endif %}
{% empty %}
    No sample input available.
{% endfor %}</code></pre>

<h4 class="mt-4">Sample Output:</h4>
<pre class="bg-light p-3 rounded border"><code>{% for tc in problem.test_cases.all %}
    {% if not tc.is_hidden %}
        {{ tc.expected_output }}
    {% endif %}
{% empty %}
    No sample output available.
{% endfor %}</code></pre>
            </div>

            <div class="card p-4 mb-4">
                <h3 class="mb-3">Submit Your Solution</h3>
                {% if user.is_authenticated %}
                    <form id="submissionForm" method="post" action="{% url 'submissions:submit_code' problem.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="languageSelect" class="form-label">Language</label>
                            <select class="form-select rounded-md" id="languageSelect" name="language" required>
                                <option value="python">Python</option>
                                <option value="cpp">C++</option>
                                <option value="java">Java</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="codeEditor" class="form-label">Your Code</label>
                            <textarea class="form-control rounded-md" id="codeEditor" name="code" rows="15" placeholder="Write your code here..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success rounded-md">Submit Code</button>
                    </form>
                {% else %}
                    <div class="alert alert-warning text-center" role="alert">
                        Please <a href="{% url 'users:login' %}">log in</a> to submit a solution.
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-4">
                <h3 class="mb-3">Your Submissions</h3>
                <div id="userSubmissionsList">
                    {% if user_submissions %}
                        <ul class="list-group">
                            {% for submission in user_submissions %}
                                <a href="{% url 'submissions:detail' submission.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 rounded-md" id="submission-{{ submission.id }}">
                                    <div>
                                        <strong>{{ submission.submitted_at|date:"M d, H:i" }}</strong> -
                                        <span class="badge bg-info text-dark me-1">{{ submission.language|capfirst }}</span>
                                        <span class="badge {% if submission.final_verdict == 'accepted' %}bg-success{% elif submission.final_verdict == 'wrong_answer' or submission.final_verdict == 'runtime_error' or submission.final_verdict == 'compilation_error' %}bg-danger{% elif submission.final_verdict == 'time_limit_exceeded' or submission.final_verdict == 'memory_limit_exceeded' %}bg-warning text-dark{% else %}bg-secondary{% endif %}" data-submission-status="{{ submission.status }}">
                                            {{ submission.get_final_verdict_display }}
                                        </span>
                                    </div>
                                    <small>
                                        {% if submission.total_test_cases %}
                                            {{ submission.passed_test_cases|default:0 }}/{{ submission.total_test_cases }}
                                        {% endif %}
                                        {% if submission.execution_time %}
                                            | {{ submission.execution_time }}s
                                        {% endif %}
                                    </small>
                                </a>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-secondary" role="alert">
                            You have no submissions for this problem yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script id="problem-data" type="application/json">
{
    "problemId": {% if problem.id %}{{ problem.id }}{% else %}0{% endif %}
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const submissionList = document.getElementById('userSubmissionsList');
        const problemData = JSON.parse(document.getElementById('problem-data').textContent);
        const problemId = problemData.problemId;
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';

        // Function to format verdict string from camelCase/snake_case to Title Case
        function formatVerdictText(verdictString) {
            return verdictString
                .replace(/_/g, ' ') // Replace underscores with spaces
                .split(' ')         // Split into words
                .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize first letter of each word
                .join(' ');         // Join back with spaces
        }

        // Function to fetch and update submission status
        function updateSubmissionStatus(submissionId) {
            if (!csrfToken) {
                console.error('CSRF token not found');
                return;
            }

            fetch('/submissions/api/status/' + submissionId + '/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                const submissionItem = document.getElementById('submission-' + submissionId);
                if (submissionItem) {
                    const statusBadge = submissionItem.querySelector('.badge[data-submission-status]');
                    if (statusBadge) {
                        // Use the JavaScript helper function to format the verdict from API
                        statusBadge.textContent = formatVerdictText(data.final_verdict);
                        
                        // Remove all status classes
                        statusBadge.classList.remove('bg-secondary', 'bg-info', 'bg-warning', 'bg-danger', 'bg-success', 'text-dark');
                        
                        // Add appropriate status class
                        if (data.final_verdict === 'accepted') {
                            statusBadge.classList.add('bg-success');
                        } else if (['wrong_answer', 'runtime_error', 'compilation_error'].indexOf(data.final_verdict) !== -1) {
                            statusBadge.classList.add('bg-danger');
                        } else if (['time_limit_exceeded', 'memory_limit_exceeded'].indexOf(data.final_verdict) !== -1) {
                            statusBadge.classList.add('bg-warning', 'text-dark');
                        } else {
                            statusBadge.classList.add('bg-secondary');
                        }
                        
                        statusBadge.dataset.submissionStatus = data.status;

                        // Update detailed metrics if available
                        const smallElement = submissionItem.querySelector('small');
                        if (smallElement) {
                            let metricsHtml = '';
                            // Ensure default to 0 if null for passed_test_cases
                            if (data.total_test_cases) {
                                metricsHtml += (data.passed_test_cases || 0) + '/' + data.total_test_cases;
                            }
                            if (data.execution_time) {
                                metricsHtml += ' | ' + data.execution_time + 's';
                            }
                            smallElement.innerHTML = metricsHtml;
                        }

                        if (data.status === 'finished') {
                            console.log('Submission ' + submissionId + ' finished with verdict: ' + data.final_verdict);
                        } else {
                            // Continue polling if not finished
                            setTimeout(function() { 
                                updateSubmissionStatus(submissionId); 
                            }, 3000);
                        }
                    }
                }
            })
            .catch(function(error) {
                console.error('Error fetching submission status:', error);
                // Retry after a longer delay on error
                setTimeout(function() { 
                    updateSubmissionStatus(submissionId); 
                }, 10000);
            });
        }

        // Identify pending submissions on page load and start polling
        const pendingSubmissions = document.querySelectorAll('.badge[data-submission-status="pending"], .badge[data-submission-status="processing"]');
        for (let i = 0; i < pendingSubmissions.length; i++) {
            const badge = pendingSubmissions[i];
            const submissionItem = badge.closest('li[id^="submission-"]');
            if (submissionItem) {
                const submissionId = submissionItem.id.split('-')[1];
                if (submissionId) {
                    updateSubmissionStatus(submissionId);
                }
            }
        }

        // Handle form submission
        const submissionForm = document.getElementById('submissionForm');
        if (submissionForm) {
            submissionForm.addEventListener('submit', function(e) {
                const submitButton = submissionForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';
                    
                    // Re-enable button after a delay to prevent accidental double submissions
                    setTimeout(function() {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submit Code';
                    }, 3000);
                }
            });
        }
    });
</script>
<style>
    /* Custom styles for badges as used in problem_list.html */
    .badge.bg-easy { background-color: #28a745 !important; }
    .badge.bg-medium { background-color: #ffc107 !important; }
    .badge.bg-hard { background-color: #dc3545 !important; }
</style>
{% endblock %}